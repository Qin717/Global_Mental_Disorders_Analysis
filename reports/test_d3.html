<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D3.js Test - Mental Disorders Data</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .chart {
            margin: 20px 0;
        }
        .bar {
            fill: #3498db;
            transition: all 0.3s ease;
        }
        .bar:hover {
            fill: #2980b9;
        }
        .axis {
            font-size: 12px;
        }
        .axis-label {
            font-size: 14px;
            font-weight: bold;
        }
        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            pointer-events: none;
            opacity: 0;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .loading { background: #d1ecf1; color: #0c5460; }
    </style>
</head>
<body>
    <div class="container">
        <h1>D3.js Mental Disorders Data Test</h1>
        <div id="status" class="status loading">Loading data...</div>
        <div id="dataInfo"></div>
        <div class="chart">
            <h3>Top 10 Countries - Anxiety Disorders</h3>
            <div id="chart"></div>
        </div>
    </div>

    <div class="tooltip" id="tooltip"></div>

    <script>
        const status = d3.select('#status');
        const dataInfo = d3.select('#dataInfo');
        const tooltip = d3.select('#tooltip');

        async function loadAndTestData() {
            try {
                status.classed('loading', true)
                     .classed('error', false)
                     .classed('success', false)
                     .text('Loading country data...');

                // Load country data
                const countryResponse = await fetch('Q4_country_data.csv');
                if (!countryResponse.ok) {
                    throw new Error(`HTTP error! status: ${countryResponse.status}`);
                }
                
                const countryText = await countryResponse.text();
                console.log('Raw CSV text (first 200 chars):', countryText.substring(0, 200));
                
                const countryData = d3.csvParse(countryText, d3.autoType);
                console.log('Parsed country data:', countryData.slice(0, 5));
                
                status.classed('loading', false)
                     .classed('error', false)
                     .classed('success', true)
                     .text(`✅ Successfully loaded ${countryData.length} country records`);

                // Display data info
                dataInfo.html(`
                    <h4>Data Summary:</h4>
                    <ul>
                        <li>Total records: ${countryData.length}</li>
                        <li>Unique countries: ${new Set(countryData.map(d => d.country)).size}</li>
                        <li>Unique disorders: ${new Set(countryData.map(d => d.disorder)).size}</li>
                        <li>Prevalence range: ${d3.min(countryData, d => d.avg_prevalence_percent).toFixed(2)}% - ${d3.max(countryData, d => d.avg_prevalence_percent).toFixed(2)}%</li>
                    </ul>
                `);

                // Create simple chart
                createSimpleChart(countryData);

            } catch (error) {
                console.error('Error loading data:', error);
                status.classed('loading', false)
                     .classed('error', true)
                     .classed('success', false)
                     .text(`❌ Error: ${error.message}`);
            }
        }

        function createSimpleChart(data) {
            // Filter for anxiety disorders and get top 10
            const anxietyData = data
                .filter(d => d.disorder === 'Anxiety disorders')
                .sort((a, b) => b.avg_prevalence_percent - a.avg_prevalence_percent)
                .slice(0, 10);

            console.log('Anxiety data for chart:', anxietyData);

            const margin = { top: 20, right: 30, bottom: 60, left: 100 };
            const width = 600 - margin.left - margin.right;
            const height = 400 - margin.top - margin.bottom;

            // Clear previous chart
            d3.select('#chart').selectAll('*').remove();

            const svg = d3.select('#chart')
                .append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom);

            const g = svg.append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);

            // Scales
            const xScale = d3.scaleLinear()
                .domain([0, d3.max(anxietyData, d => d.avg_prevalence_percent)])
                .range([0, width]);

            const yScale = d3.scaleBand()
                .domain(anxietyData.map(d => d.country))
                .range([0, height])
                .padding(0.1);

            // Bars
            g.selectAll('.bar')
                .data(anxietyData)
                .enter()
                .append('rect')
                .attr('class', 'bar')
                .attr('x', 0)
                .attr('y', d => yScale(d.country))
                .attr('width', d => xScale(d.avg_prevalence_percent))
                .attr('height', yScale.bandwidth())
                .on('mouseover', function(event, d) {
                    tooltip.style('opacity', 1)
                        .html(`
                            <strong>${d.country}</strong><br/>
                            Prevalence: ${d.avg_prevalence_percent}%
                        `)
                        .style('left', (event.pageX + 10) + 'px')
                        .style('top', (event.pageY - 10) + 'px');
                })
                .on('mouseout', function() {
                    tooltip.style('opacity', 0);
                });

            // Axes
            g.append('g')
                .attr('class', 'axis')
                .attr('transform', `translate(0,${height})`)
                .call(d3.axisBottom(xScale).tickFormat(d => d + '%'));

            g.append('g')
                .attr('class', 'axis')
                .call(d3.axisLeft(yScale));

            // Labels
            g.append('text')
                .attr('class', 'axis-label')
                .attr('transform', 'rotate(-90)')
                .attr('y', 0 - margin.left)
                .attr('x', 0 - (height / 2))
                .attr('dy', '1em')
                .style('text-anchor', 'middle')
                .text('Countries');

            g.append('text')
                .attr('class', 'axis-label')
                .attr('transform', `translate(${width/2}, ${height + margin.bottom - 10})`)
                .style('text-anchor', 'middle')
                .text('Prevalence (%)');
        }

        // Start loading data
        loadAndTestData();
    </script>
</body>
</html>
