<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mental Disorders Analysis - Advanced D3.js Visualizations</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #4f81bd 0%, #70ad47 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: 300;
        }
        
        .header p {
            margin: 10px 0 0 0;
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .dashboard {
            padding: 30px;
        }
        
        .chart-container {
            margin-bottom: 40px;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }
        
        .chart-title {
            font-size: 1.5em;
            font-weight: 600;
            margin-bottom: 20px;
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }
        
        .controls {
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .control-group label {
            font-weight: 600;
            color: #555;
            font-size: 0.9em;
        }
        
        select, input {
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        select:focus, input:focus {
            outline: none;
            border-color: #3498db;
        }
        
        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 1000;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .tooltip h4 {
            margin: 0 0 5px 0;
            color: #3498db;
        }
        
        .tooltip p {
            margin: 2px 0;
        }
        
        .bubble {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .bubble:hover {
            stroke: #333;
            stroke-width: 3;
        }
        
        .bubble-label {
            font-size: 10px;
            text-anchor: middle;
            pointer-events: none;
            fill: white;
            font-weight: bold;
        }
        
        .sankey-link {
            fill: none;
            stroke-opacity: 0.6;
            transition: stroke-opacity 0.3s;
        }
        
        .sankey-link:hover {
            stroke-opacity: 0.8;
        }
        
        .sankey-node {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .sankey-node:hover {
            opacity: 0.8;
        }
        
        .sankey-node-label {
            font-size: 12px;
            pointer-events: none;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 3px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Mental Disorders Analysis</h1>
            <p>Advanced D3.js Visualizations: Bubble Chart & Sankey Diagram</p>
        </div>
        
        <div class="dashboard">
            <div class="stats-grid" id="statsGrid">
                <div class="stat-card">
                    <div class="stat-value" id="totalCountries">-</div>
                    <div class="stat-label">Countries Analyzed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalDisorders">-</div>
                    <div class="stat-label">Mental Disorders</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="avgPrevalence">-</div>
                    <div class="stat-label">Average Prevalence (%)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="highestPrevalence">-</div>
                    <div class="stat-label">Highest Prevalence (%)</div>
                </div>
            </div>
            
            <!-- Chart 1: Interactive Bubble Chart -->
            <div class="chart-container">
                <h2 class="chart-title">Interactive Bubble Chart: Countries & Mental Disorders</h2>
                <div class="controls">
                    <div class="control-group">
                        <label for="bubbleDisorderSelect">Filter by Disorder:</label>
                        <select id="bubbleDisorderSelect">
                            <option value="all">All Disorders</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label for="bubbleSize">Bubble Size Scale:</label>
                        <input type="range" id="bubbleSize" min="1" max="5" value="3" step="0.5">
                    </div>
                    <div class="control-group">
                        <label for="bubbleCount">Number of Countries:</label>
                        <input type="number" id="bubbleCount" value="20" min="5" max="50">
                    </div>
                </div>
                <div id="bubbleChart"></div>
            </div>
            
            <!-- Chart 2: Interactive Sankey Diagram -->
            <div class="chart-container">
                <h2 class="chart-title">Sankey Diagram: Age Groups & Mental Disorders Flow</h2>
                <div class="controls">
                    <div class="control-group">
                        <label for="sankeyFilter">Filter by Disorder:</label>
                        <select id="sankeyFilter">
                            <option value="all">All Disorders</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label for="sankeyThreshold">Minimum Prevalence:</label>
                        <input type="number" id="sankeyThreshold" value="1.0" min="0.1" max="5.0" step="0.1">
                    </div>
                </div>
                <div id="sankeyChart"></div>
            </div>
        </div>
    </div>
    
    <div class="tooltip" id="tooltip"></div>
    
    <script>
        // Global variables
        let countryData = [];
        let ageData = [];
        let allData = [];
        
        // Color schemes
        const colorSchemes = {
            disorders: d3.scaleOrdinal(d3.schemeCategory10),
            countries: d3.scaleOrdinal(d3.schemeSet3),
            ageGroups: d3.scaleOrdinal(d3.schemePaired)
        };
        
        // Dimensions
        const dimensions = {
            bubbleChart: { width: 1000, height: 600, margin: { top: 20, right: 20, bottom: 20, left: 20 } },
            sankeyChart: { width: 1000, height: 500, margin: { top: 20, right: 20, bottom: 20, left: 20 } }
        };
        
        // Tooltip
        const tooltip = d3.select("#tooltip");
        
        // Load data
        async function loadData() {
            try {
                console.log('Starting data load...');
                
                // Load country data
                console.log('Loading country data...');
                const countryResponse = await fetch('Q4_country_data.csv');
                if (!countryResponse.ok) {
                    throw new Error(`Failed to load country data: ${countryResponse.status} ${countryResponse.statusText}`);
                }
                const countryText = await countryResponse.text();
                countryData = d3.csvParse(countryText, d3.autoType);
                console.log('Country data parsed, records:', countryData.length);
                
                // Load age data
                console.log('Loading age data...');
                const ageResponse = await fetch('Q4_age_data.csv');
                if (!ageResponse.ok) {
                    throw new Error(`Failed to load age data: ${ageResponse.status} ${ageResponse.statusText}`);
                }
                const ageText = await ageResponse.text();
                ageData = d3.csvParse(ageText, d3.autoType);
                console.log('Age data parsed, records:', ageData.length);
                
                // Combine all data
                allData = [...countryData, ...ageData];
                console.log('Total combined records:', allData.length);
                
                // Update statistics
                updateStatistics();
                
                // Populate select options
                populateSelects();
                
                // Create visualizations
                console.log('Creating visualizations...');
                createBubbleChart();
                createSankeyChart();
                
                console.log('All visualizations created successfully!');
                
            } catch (error) {
                console.error('Error loading data:', error);
                document.querySelector('.dashboard').innerHTML = 
                    `<div class="loading" style="color: red; background: #ffe6e6; padding: 20px; border-radius: 5px;">
                        <h3>Error Loading Data</h3>
                        <p><strong>Error:</strong> ${error.message}</p>
                        <p><strong>Make sure you're running a local server:</strong></p>
                        <code>cd /Users/qinqin/Desktop/Mental_Disorders/reports && python3 -m http.server 8001</code><br/>
                        <code>Then open: http://localhost:8001/Q4_new_visualizations.html</code>
                    </div>`;
            }
        }
        
        function updateStatistics() {
            const uniqueCountries = new Set(countryData.map(d => d.country)).size;
            const uniqueDisorders = new Set(allData.map(d => d.disorder)).size;
            const avgPrevalence = d3.mean(allData, d => d.avg_prevalence_percent);
            const maxPrevalence = d3.max(allData, d => d.avg_prevalence_percent);
            
            document.getElementById('totalCountries').textContent = uniqueCountries;
            document.getElementById('totalDisorders').textContent = uniqueDisorders;
            document.getElementById('avgPrevalence').textContent = avgPrevalence.toFixed(2);
            document.getElementById('highestPrevalence').textContent = maxPrevalence.toFixed(2);
        }
        
        function populateSelects() {
            const disorders = [...new Set(allData.map(d => d.disorder))].sort();
            
            const bubbleDisorderSelect = d3.select('#bubbleDisorderSelect');
            const sankeyFilter = d3.select('#sankeyFilter');
            
            bubbleDisorderSelect.selectAll('option')
                .data(['all', ...disorders])
                .enter()
                .append('option')
                .attr('value', d => d)
                .text(d => d === 'all' ? 'All Disorders' : d);
            
            sankeyFilter.selectAll('option')
                .data(['all', ...disorders])
                .enter()
                .append('option')
                .attr('value', d => d)
                .text(d => d === 'all' ? 'All Disorders' : d);
        }
        
        function createBubbleChart() {
            console.log('Creating bubble chart...');
            const container = d3.select('#bubbleChart');
            container.selectAll('*').remove();
            
            const svg = container.append('svg')
                .attr('width', dimensions.bubbleChart.width)
                .attr('height', dimensions.bubbleChart.height);
            
            const width = dimensions.bubbleChart.width - dimensions.bubbleChart.margin.left - dimensions.bubbleChart.margin.right;
            const height = dimensions.bubbleChart.height - dimensions.bubbleChart.margin.top - dimensions.bubbleChart.margin.bottom;
            
            const g = svg.append('g')
                .attr('transform', `translate(${dimensions.bubbleChart.margin.left},${dimensions.bubbleChart.margin.top})`);
            
            // Get filtered data
            const selectedDisorder = document.getElementById('bubbleDisorderSelect').value;
            const bubbleCount = parseInt(document.getElementById('bubbleCount').value);
            const bubbleSizeScale = parseFloat(document.getElementById('bubbleSize').value);
            
            let filteredData = countryData;
            if (selectedDisorder !== 'all') {
                filteredData = countryData.filter(d => d.disorder === selectedDisorder);
            }
            
            // Get top countries by average prevalence
            const topCountries = [...new Set(filteredData.map(d => d.country))]
                .map(country => ({
                    country,
                    avgPrevalence: d3.mean(filteredData.filter(d => d.country === country), d => d.avg_prevalence_percent),
                    disorders: filteredData.filter(d => d.country === country).map(d => d.disorder)
                }))
                .sort((a, b) => b.avgPrevalence - a.avgPrevalence)
                .slice(0, bubbleCount);
            
            console.log('Top countries for bubble chart:', topCountries.length);
            
            // Create force simulation
            const simulation = d3.forceSimulation(topCountries)
                .force('x', d3.forceX(width / 2).strength(0.1))
                .force('y', d3.forceY(height / 2).strength(0.1))
                .force('collision', d3.forceCollide().radius(d => Math.sqrt(d.avgPrevalence) * bubbleSizeScale + 10))
                .force('charge', d3.forceManyBody().strength(-50));
            
            // Scale for bubble sizes
            const sizeScale = d3.scaleSqrt()
                .domain(d3.extent(topCountries, d => d.avgPrevalence))
                .range([10, 60 * bubbleSizeScale]);
            
            // Color scale
            const colorScale = d3.scaleOrdinal()
                .domain([...new Set(filteredData.map(d => d.disorder))])
                .range(d3.schemeCategory10);
            
            // Create bubbles
            const bubbles = g.selectAll('.bubble')
                .data(topCountries)
                .enter()
                .append('g')
                .attr('class', 'bubble');
            
            bubbles.append('circle')
                .attr('r', d => sizeScale(d.avgPrevalence))
                .attr('fill', d => {
                    const mainDisorder = d.disorders[0];
                    return colorScale(mainDisorder);
                })
                .attr('opacity', 0.7)
                .on('mouseover', function(event, d) {
                    tooltip.style('opacity', 1)
                        .html(`
                            <h4>${d.country}</h4>
                            <p><strong>Average Prevalence:</strong> ${d.avgPrevalence.toFixed(2)}%</p>
                            <p><strong>Disorders:</strong> ${d.disorders.join(', ')}</p>
                        `)
                        .style('left', (event.pageX + 10) + 'px')
                        .style('top', (event.pageY - 10) + 'px');
                })
                .on('mouseout', function() {
                    tooltip.style('opacity', 0);
                });
            
            // Add labels
            bubbles.append('text')
                .attr('class', 'bubble-label')
                .attr('dy', '0.35em')
                .text(d => d.country.length > 8 ? d.country.substring(0, 8) + '...' : d.country)
                .style('font-size', d => Math.min(sizeScale(d.avgPrevalence) / 3, 12) + 'px');
            
            // Update positions on simulation tick
            simulation.on('tick', () => {
                bubbles.attr('transform', d => `translate(${d.x},${d.y})`);
            });
            
            // Legend
            const legend = g.append('g')
                .attr('class', 'legend')
                .attr('transform', `translate(${width - 200}, 20)`);
            
            const legendItems = legend.selectAll('.legend-item')
                .data([...new Set(filteredData.map(d => d.disorder))])
                .enter()
                .append('g')
                .attr('class', 'legend-item')
                .attr('transform', (d, i) => `translate(0, ${i * 25})`);
            
            legendItems.append('circle')
                .attr('r', 8)
                .attr('fill', d => colorScale(d));
            
            legendItems.append('text')
                .attr('x', 15)
                .attr('y', 5)
                .style('font-size', '12px')
                .text(d => d);
        }
        
        function createSankeyChart() {
            console.log('Creating Sankey chart...');
            const container = d3.select('#sankeyChart');
            container.selectAll('*').remove();
            
            const svg = container.append('svg')
                .attr('width', dimensions.sankeyChart.width)
                .attr('height', dimensions.sankeyChart.height);
            
            const width = dimensions.sankeyChart.width - dimensions.sankeyChart.margin.left - dimensions.sankeyChart.margin.right;
            const height = dimensions.sankeyChart.height - dimensions.sankeyChart.margin.top - dimensions.sankeyChart.margin.bottom;
            
            const g = svg.append('g')
                .attr('transform', `translate(${dimensions.sankeyChart.margin.left},${dimensions.sankeyChart.margin.top})`);
            
            // Get filtered data
            const selectedDisorder = document.getElementById('sankeyFilter').value;
            const threshold = parseFloat(document.getElementById('sankeyThreshold').value);
            
            let filteredData = ageData;
            if (selectedDisorder !== 'all') {
                filteredData = ageData.filter(d => d.disorder === selectedDisorder);
            }
            
            // Filter by threshold
            filteredData = filteredData.filter(d => d.avg_prevalence_percent >= threshold);
            
            // Create nodes and links for Sankey
            const ageGroups = [...new Set(filteredData.map(d => d.age_group))].sort((a, b) => {
                const ageA = parseInt(a.split('-')[0]);
                const ageB = parseInt(b.split('-')[0]);
                return ageA - ageB;
            });
            
            const disorders = [...new Set(filteredData.map(d => d.disorder))];
            
            // Create nodes
            const nodes = [
                ...ageGroups.map(age => ({ id: age, type: 'age', group: 0 })),
                ...disorders.map(disorder => ({ id: disorder, type: 'disorder', group: 1 }))
            ];
            
            // Create links
            const links = filteredData.map(d => ({
                source: d.age_group,
                target: d.disorder,
                value: d.avg_prevalence_percent
            }));
            
            console.log('Sankey nodes:', nodes.length, 'links:', links.length);
            
            // Simple Sankey layout (simplified version)
            const nodeWidth = 20;
            const nodeSpacing = 50;
            
            // Position nodes
            const ageNodes = nodes.filter(n => n.type === 'age');
            const disorderNodes = nodes.filter(n => n.type === 'disorder');
            
            ageNodes.forEach((node, i) => {
                node.x = 50;
                node.y = i * nodeSpacing + 50;
                node.width = nodeWidth;
                node.height = 30;
            });
            
            disorderNodes.forEach((node, i) => {
                node.x = width - 150;
                node.y = i * nodeSpacing + 50;
                node.width = nodeWidth;
                node.height = 30;
            });
            
            // Color scale
            const colorScale = d3.scaleOrdinal()
                .domain(disorders)
                .range(d3.schemeCategory10);
            
            // Create links
            const linkGroup = g.append('g').attr('class', 'links');
            
            linkGroup.selectAll('.sankey-link')
                .data(links)
                .enter()
                .append('path')
                .attr('class', 'sankey-link')
                .attr('d', d => {
                    const sourceNode = nodes.find(n => n.id === d.source);
                    const targetNode = nodes.find(n => n.id === d.target);
                    
                    if (!sourceNode || !targetNode) return '';
                    
                    const x1 = sourceNode.x + sourceNode.width;
                    const y1 = sourceNode.y + sourceNode.height / 2;
                    const x2 = targetNode.x;
                    const y2 = targetNode.y + targetNode.height / 2;
                    
                    return `M${x1},${y1} C${x1 + 50},${y1} ${x2 - 50},${y2} ${x2},${y2}`;
                })
                .attr('stroke', d => colorScale(d.target))
                .attr('stroke-width', d => Math.max(1, d.value / 2))
                .on('mouseover', function(event, d) {
                    tooltip.style('opacity', 1)
                        .html(`
                            <h4>${d.source} → ${d.target}</h4>
                            <p><strong>Prevalence:</strong> ${d.value.toFixed(2)}%</p>
                        `)
                        .style('left', (event.pageX + 10) + 'px')
                        .style('top', (event.pageY - 10) + 'px');
                })
                .on('mouseout', function() {
                    tooltip.style('opacity', 0);
                });
            
            // Create nodes
            const nodeGroup = g.append('g').attr('class', 'nodes');
            
            nodeGroup.selectAll('.sankey-node')
                .data(nodes)
                .enter()
                .append('rect')
                .attr('class', 'sankey-node')
                .attr('x', d => d.x)
                .attr('y', d => d.y)
                .attr('width', d => d.width)
                .attr('height', d => d.height)
                .attr('fill', d => d.type === 'age' ? '#3498db' : colorScale(d.id))
                .attr('opacity', 0.8)
                .on('mouseover', function(event, d) {
                    tooltip.style('opacity', 1)
                        .html(`
                            <h4>${d.id}</h4>
                            <p><strong>Type:</strong> ${d.type}</p>
                        `)
                        .style('left', (event.pageX + 10) + 'px')
                        .style('top', (event.pageY - 10) + 'px');
                })
                .on('mouseout', function() {
                    tooltip.style('opacity', 0);
                });
            
            // Add labels
            nodeGroup.selectAll('.sankey-node-label')
                .data(nodes)
                .enter()
                .append('text')
                .attr('class', 'sankey-node-label')
                .attr('x', d => d.x + (d.type === 'age' ? -10 : d.width + 10))
                .attr('y', d => d.y + d.height / 2)
                .attr('dy', '0.35em')
                .attr('text-anchor', d => d.type === 'age' ? 'end' : 'start')
                .text(d => d.id.length > 15 ? d.id.substring(0, 15) + '...' : d.id)
                .style('font-size', '11px');
        }
        
        // Event listeners
        document.getElementById('bubbleDisorderSelect').addEventListener('change', createBubbleChart);
        document.getElementById('bubbleSize').addEventListener('input', createBubbleChart);
        document.getElementById('bubbleCount').addEventListener('change', createBubbleChart);
        document.getElementById('sankeyFilter').addEventListener('change', createSankeyChart);
        document.getElementById('sankeyThreshold').addEventListener('input', createSankeyChart);
        
        // Initialize
        loadData();
    </script>
</body>
</html>
