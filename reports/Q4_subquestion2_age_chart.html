<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Question 4 - Sub-question 2: Age Groups Analysis</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #4f81bd 0%, #70ad47 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0;
            font-size: 2.2em;
            font-weight: 300;
        }
        
        .header p {
            margin: 10px 0 0 0;
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .dashboard {
            padding: 30px;
        }
        
        .chart-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            margin-bottom: 30px;
        }
        
        .chart-title {
            font-size: 1.4em;
            font-weight: 600;
            margin-bottom: 20px;
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }
        
        .controls {
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .control-group label {
            font-weight: 600;
            color: #555;
            font-size: 0.9em;
        }
        
        select, input {
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        select:focus, input:focus {
            outline: none;
            border-color: #3498db;
        }
        
        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 1000;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .tooltip h4 {
            margin: 0 0 5px 0;
            color: #3498db;
        }
        
        .tooltip p {
            margin: 2px 0;
        }
        
        .bar {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .bar:hover {
            opacity: 0.8;
            stroke: #333;
            stroke-width: 2;
        }
        
        .line {
            fill: none;
            stroke-width: 3;
            transition: stroke-width 0.3s;
        }
        
        .line:hover {
            stroke-width: 5;
        }
        
        .dot {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .dot:hover {
            r: 8;
            stroke: #333;
            stroke-width: 2;
        }
        
        .axis {
            font-size: 12px;
        }
        
        .axis-label {
            font-size: 14px;
            font-weight: 600;
            fill: #555;
        }
        
        .grid-line {
            stroke: #e0e0e0;
            stroke-width: 1;
            opacity: 0.5;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }
        
        .value-label {
            font-size: 11px;
            text-anchor: middle;
            fill: #333;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Question 4 - Sub-question 2</h1>
            <p>Age Groups by Mental Disorder Prevalence (1990-2021)</p>
        </div>
        
        <div class="dashboard">
            <div class="stats-grid" id="statsGrid">
                <div class="stat-card">
                    <div class="stat-value" id="totalAgeGroups">-</div>
                    <div class="stat-label">Age Groups</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalDisorders">-</div>
                    <div class="stat-label">Mental Disorders</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="avgPrevalence">-</div>
                    <div class="stat-label">Average Prevalence (%)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="highestPrevalence">-</div>
                    <div class="stat-label">Highest Prevalence (%)</div>
                </div>
            </div>
            
            <!-- Main Age Group Chart -->
            <div class="chart-container">
                <h2 class="chart-title">Mental Disorder Prevalence by Age Group</h2>
                <div class="controls">
                    <div class="control-group">
                        <label for="disorderSelect">Select Mental Disorder:</label>
                        <select id="disorderSelect">
                            <option value="all">All Disorders (Average)</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label for="chartType">Chart Type:</label>
                        <select id="chartType">
                            <option value="bar">Bar Chart</option>
                            <option value="line">Line Chart</option>
                        </select>
                    </div>
                </div>
                <div id="ageChart"></div>
            </div>
            
            <!-- Age Group Comparison Chart -->
            <div class="chart-container">
                <h2 class="chart-title">Age Group Comparison Across All Disorders</h2>
                <div id="comparisonChart"></div>
            </div>
        </div>
    </div>
    
    <div class="tooltip" id="tooltip"></div>
    
    <script>
        // Global variables
        let ageData = [];
        let allData = [];
        
        // Color schemes
        const colorSchemes = {
            disorders: d3.scaleOrdinal(d3.schemeCategory10),
            ageGroups: d3.scaleOrdinal(d3.schemePaired)
        };
        
        // Tooltip
        const tooltip = d3.select("#tooltip");
        
        // Load data
        async function loadData() {
            try {
                console.log('Starting age data load...');
                updateStatus('Loading age data...', 'loading');
                
                // Fetch age data
                const response = await fetch('Q4_age_data.csv');
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const text = await response.text();
                console.log('Age data loaded, length:', text.length);
                
                // Parse CSV
                ageData = d3.csvParse(text, d3.autoType);
                console.log('Age data parsed, records:', ageData.length);
                
                if (ageData.length === 0) {
                    throw new Error('No data found in CSV file');
                }
                
                allData = ageData;
                
                // Show success
                updateStatus(`✅ Successfully loaded ${ageData.length} age group records`, 'success');
                
                // Populate controls
                populateControls();
                
                // Create initial chart
                createAgeChart();
                
                // Create comparison chart
                createComparisonChart();
                
                // Show data info
                showDataInfo();
                
            } catch (error) {
                console.error('Error:', error);
                updateStatus(`❌ Error: ${error.message}`, 'error');
                showErrorDetails(error);
            }
        }
        
        function updateStatus(message, type) {
            const status = document.getElementById('statsGrid');
            // We'll show status in the data info section instead
        }
        
        function showErrorDetails(error) {
            const dashboard = document.querySelector('.dashboard');
            const errorDiv = document.createElement('div');
            errorDiv.style.cssText = 'color: red; background: #ffe6e6; padding: 20px; border-radius: 5px; margin: 20px 0;';
            errorDiv.innerHTML = `
                <h3>Error Loading Data</h3>
                <p><strong>Error:</strong> ${error.message}</p>
                <p><strong>Make sure you're running a local server:</strong></p>
                <code>cd /Users/qinqin/Desktop/Mental_Disorders/reports && python3 -m http.server 8001</code><br/>
                <code>Then open: http://localhost:8001/Q4_subquestion2_age_chart.html</code>
            `;
            dashboard.appendChild(errorDiv);
        }
        
        function populateControls() {
            const disorders = [...new Set(allData.map(d => d.disorder))].sort();
            const select = document.getElementById('disorderSelect');
            
            // Clear existing options
            select.innerHTML = '<option value="all">All Disorders (Average)</option>';
            
            // Add disorder options
            disorders.forEach(disorder => {
                const option = document.createElement('option');
                option.value = disorder;
                option.textContent = disorder;
                select.appendChild(option);
            });
        }
        
        function showDataInfo() {
            const uniqueAgeGroups = new Set(allData.map(d => d.age_group)).size;
            const uniqueDisorders = new Set(allData.map(d => d.disorder)).size;
            const avgPrevalence = d3.mean(allData, d => d.avg_prevalence_percent);
            const maxPrevalence = d3.max(allData, d => d.avg_prevalence_percent);
            
            document.getElementById('totalAgeGroups').textContent = uniqueAgeGroups;
            document.getElementById('totalDisorders').textContent = uniqueDisorders;
            document.getElementById('avgPrevalence').textContent = avgPrevalence.toFixed(2);
            document.getElementById('highestPrevalence').textContent = maxPrevalence.toFixed(2);
        }
        
        function createAgeChart() {
            console.log('Creating age chart...');
            
            // Get filter values
            const selectedDisorder = document.getElementById('disorderSelect').value;
            const chartType = document.getElementById('chartType').value;
            
            // Filter data
            let filteredData = ageData;
            if (selectedDisorder !== 'all') {
                filteredData = ageData.filter(d => d.disorder === selectedDisorder);
            }
            
            // Calculate age group averages and sort by age
            const ageGroupAverages = [...new Set(filteredData.map(d => d.age_group))]
                .map(ageGroup => {
                    const ageData = filteredData.filter(d => d.age_group === ageGroup);
                    return {
                        ageGroup,
                        avgPrevalence: d3.mean(ageData, d => d.avg_prevalence_percent),
                        maxPrevalence: d3.max(ageData, d => d.avg_prevalence_percent),
                        minPrevalence: d3.min(ageData, d => d.avg_prevalence_percent),
                        disorderCount: ageData.length,
                        disorders: ageData.map(d => d.disorder)
                    };
                })
                .sort((a, b) => {
                    // Sort by age numerically
                    const ageA = parseInt(a.ageGroup.split('-')[0]);
                    const ageB = parseInt(b.ageGroup.split('-')[0]);
                    return ageA - ageB;
                });
            
            console.log('Age groups for chart:', ageGroupAverages.length);
            
            // Clear previous chart
            d3.select('#ageChart').selectAll('*').remove();
            
            // Chart dimensions
            const margin = { top: 20, right: 30, bottom: 80, left: 80 };
            const width = 800 - margin.left - margin.right;
            const height = 400 - margin.top - margin.bottom;
            
            // Create SVG
            const svg = d3.select('#ageChart')
                .append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom);
            
            const g = svg.append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);
            
            // Color scale
            const colorScale = d3.scaleOrdinal()
                .domain(ageGroupAverages.map(d => d.ageGroup))
                .range(d3.schemePaired);
            
            if (chartType === 'bar') {
                createAgeBarChart(g, ageGroupAverages, width, height, colorScale, margin);
            } else {
                createAgeLineChart(g, ageGroupAverages, width, height, colorScale, margin);
            }
        }
        
        function createAgeBarChart(g, data, width, height, colorScale, margin) {
            // Scales
            const xScale = d3.scaleBand()
                .domain(data.map(d => d.ageGroup))
                .range([0, width])
                .padding(0.1);
            
            const yScale = d3.scaleLinear()
                .domain([0, d3.max(data, d => d.avgPrevalence)])
                .range([height, 0]);
            
            // Add grid lines
            g.selectAll('.grid-line')
                .data(yScale.ticks(10))
                .enter()
                .append('line')
                .attr('class', 'grid-line')
                .attr('x1', 0)
                .attr('x2', width)
                .attr('y1', d => yScale(d))
                .attr('y2', d => yScale(d));
            
            // Bars
            g.selectAll('.bar')
                .data(data)
                .enter()
                .append('rect')
                .attr('class', 'bar')
                .attr('x', d => xScale(d.ageGroup))
                .attr('y', d => yScale(d.avgPrevalence))
                .attr('width', xScale.bandwidth())
                .attr('height', d => height - yScale(d.avgPrevalence))
                .attr('fill', d => colorScale(d.ageGroup))
                .attr('opacity', 0.8)
                .on('mouseover', function(event, d) {
                    tooltip.style('opacity', 1)
                        .html(`
                            <h4>Age Group: ${d.ageGroup}</h4>
                            <p><strong>Average Prevalence:</strong> ${d.avgPrevalence.toFixed(2)}%</p>
                            <p><strong>Range:</strong> ${d.minPrevalence.toFixed(2)}% - ${d.maxPrevalence.toFixed(2)}%</p>
                            <p><strong>Disorders:</strong> ${d.disorderCount}</p>
                            <p><strong>Disorder Types:</strong> ${d.disorders.join(', ')}</p>
                        `)
                        .style('left', (event.pageX + 10) + 'px')
                        .style('top', (event.pageY - 10) + 'px');
                })
                .on('mouseout', function() {
                    tooltip.style('opacity', 0);
                });
            
            // Value labels
            g.selectAll('.value-label')
                .data(data)
                .enter()
                .append('text')
                .attr('class', 'value-label')
                .attr('x', d => xScale(d.ageGroup) + xScale.bandwidth() / 2)
                .attr('y', d => yScale(d.avgPrevalence) - 5)
                .attr('text-anchor', 'middle')
                .text(d => d.avgPrevalence.toFixed(2) + '%');
            
            // Axes
            g.append('g')
                .attr('class', 'axis')
                .attr('transform', `translate(0,${height})`)
                .call(d3.axisBottom(xScale))
                .selectAll('text')
                .style('text-anchor', 'end')
                .attr('dx', '-.8em')
                .attr('dy', '.15em')
                .attr('transform', 'rotate(-45)');
            
            g.append('g')
                .attr('class', 'axis')
                .call(d3.axisLeft(yScale).tickFormat(d => d + '%'));
            
            // Labels
            g.append('text')
                .attr('class', 'axis-label')
                .attr('transform', 'rotate(-90)')
                .attr('y', 0 - margin.left)
                .attr('x', 0 - (height / 2))
                .attr('dy', '1em')
                .style('text-anchor', 'middle')
                .text('Average Prevalence (%)');
            
            g.append('text')
                .attr('class', 'axis-label')
                .attr('transform', `translate(${width/2}, ${height + margin.bottom - 10})`)
                .style('text-anchor', 'middle')
                .text('Age Groups');
        }
        
        function createAgeLineChart(g, data, width, height, colorScale, margin) {
            // Scales
            const xScale = d3.scaleBand()
                .domain(data.map(d => d.ageGroup))
                .range([0, width])
                .padding(0.1);
            
            const yScale = d3.scaleLinear()
                .domain([0, d3.max(data, d => d.avgPrevalence)])
                .range([height, 0]);
            
            // Line generator
            const line = d3.line()
                .x(d => xScale(d.ageGroup) + xScale.bandwidth() / 2)
                .y(d => yScale(d.avgPrevalence))
                .curve(d3.curveMonotoneX);
            
            // Add line
            g.append('path')
                .datum(data)
                .attr('class', 'line')
                .attr('d', line)
                .attr('stroke', '#3498db')
                .attr('stroke-width', 3)
                .attr('fill', 'none');
            
            // Add dots
            g.selectAll('.dot')
                .data(data)
                .enter()
                .append('circle')
                .attr('class', 'dot')
                .attr('cx', d => xScale(d.ageGroup) + xScale.bandwidth() / 2)
                .attr('cy', d => yScale(d.avgPrevalence))
                .attr('r', 5)
                .attr('fill', '#3498db')
                .on('mouseover', function(event, d) {
                    tooltip.style('opacity', 1)
                        .html(`
                            <h4>Age Group: ${d.ageGroup}</h4>
                            <p><strong>Average Prevalence:</strong> ${d.avgPrevalence.toFixed(2)}%</p>
                            <p><strong>Range:</strong> ${d.minPrevalence.toFixed(2)}% - ${d.maxPrevalence.toFixed(2)}%</p>
                            <p><strong>Disorders:</strong> ${d.disorderCount}</p>
                        `)
                        .style('left', (event.pageX + 10) + 'px')
                        .style('top', (event.pageY - 10) + 'px');
                })
                .on('mouseout', function() {
                    tooltip.style('opacity', 0);
                });
            
            // Axes
            g.append('g')
                .attr('class', 'axis')
                .attr('transform', `translate(0,${height})`)
                .call(d3.axisBottom(xScale))
                .selectAll('text')
                .style('text-anchor', 'end')
                .attr('dx', '-.8em')
                .attr('dy', '.15em')
                .attr('transform', 'rotate(-45)');
            
            g.append('g')
                .attr('class', 'axis')
                .call(d3.axisLeft(yScale).tickFormat(d => d + '%'));
            
            // Labels
            g.append('text')
                .attr('class', 'axis-label')
                .attr('transform', 'rotate(-90)')
                .attr('y', 0 - margin.left)
                .attr('x', 0 - (height / 2))
                .attr('dy', '1em')
                .style('text-anchor', 'middle')
                .text('Average Prevalence (%)');
            
            g.append('text')
                .attr('class', 'axis-label')
                .attr('transform', `translate(${width/2}, ${height + margin.bottom - 10})`)
                .style('text-anchor', 'middle')
                .text('Age Groups');
        }
        
        function createComparisonChart() {
            console.log('Creating comparison chart...');
            const container = d3.select('#comparisonChart');
            container.selectAll('*').remove();
            
            const margin = { top: 20, right: 50, bottom: 80, left: 80 };
            const width = 800 - margin.left - margin.right;
            const height = 400 - margin.top - margin.bottom;
            
            const svg = container.append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom);
            
            const g = svg.append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);
            
            // Get top 5 disorders by average prevalence
            const top5Disorders = [...new Set(ageData.map(d => d.disorder))]
                .map(disorder => {
                    const disorderData = ageData.filter(d => d.disorder === disorder);
                    return {
                        disorder,
                        avgPrevalence: d3.mean(disorderData, d => d.avg_prevalence_percent)
                    };
                })
                .sort((a, b) => b.avgPrevalence - a.avgPrevalence)
                .slice(0, 5);
            
            // Get data for these disorders across all age groups
            const comparisonData = top5Disorders.map(disorder => {
                const disorderAgeData = ageData.filter(d => d.disorder === disorder.disorder);
                return {
                    disorder: disorder.disorder,
                    ageGroups: disorderAgeData.map(d => ({
                        ageGroup: d.age_group,
                        prevalence: d.avg_prevalence_percent
                    }))
                };
            });
            
            // Flatten for grouped bar chart
            const flatData = [];
            comparisonData.forEach(disorder => {
                disorder.ageGroups.forEach(ageGroup => {
                    flatData.push({
                        disorder: disorder.disorder,
                        ageGroup: ageGroup.ageGroup,
                        prevalence: ageGroup.prevalence
                    });
                });
            });
            
            const ageGroups = [...new Set(flatData.map(d => d.ageGroup))].sort((a, b) => {
                const ageA = parseInt(a.split('-')[0]);
                const ageB = parseInt(b.split('-')[0]);
                return ageA - ageB;
            });
            const disorders = top5Disorders.map(d => d.disorder);
            
            // Scales
            const x0 = d3.scaleBand()
                .domain(ageGroups)
                .range([0, width])
                .padding(0.1);
            
            const x1 = d3.scaleBand()
                .domain(disorders)
                .range([0, x0.bandwidth()])
                .padding(0.05);
            
            const yScale = d3.scaleLinear()
                .domain([0, d3.max(flatData, d => d.prevalence)])
                .range([height, 0]);
            
            // Color scale
            const colorScale = d3.scaleOrdinal()
                .domain(disorders)
                .range(d3.schemeCategory10);
            
            // Create grouped bars
            g.selectAll('.age-group')
                .data(comparisonData)
                .enter()
                .append('g')
                .attr('class', 'age-group')
                .attr('transform', d => `translate(${x0(d.ageGroups[0].ageGroup)}, 0)`)
                .selectAll('.disorder-bar')
                .data(d => d.ageGroups)
                .enter()
                .append('rect')
                .attr('class', 'disorder-bar')
                .attr('x', d => x1(d.disorder))
                .attr('y', d => yScale(d.prevalence))
                .attr('width', x1.bandwidth())
                .attr('height', d => height - yScale(d.prevalence))
                .attr('fill', d => colorScale(d.disorder))
                .attr('opacity', 0.8)
                .on('mouseover', function(event, d) {
                    tooltip.style('opacity', 1)
                        .html(`
                            <h4>${d.ageGroup} - ${d.disorder}</h4>
                            <p><strong>Prevalence:</strong> ${d.prevalence.toFixed(2)}%</p>
                        `)
                        .style('left', (event.pageX + 10) + 'px')
                        .style('top', (event.pageY - 10) + 'px');
                })
                .on('mouseout', function() {
                    tooltip.style('opacity', 0);
                });
            
            // Axes
            g.append('g')
                .attr('class', 'axis')
                .attr('transform', `translate(0,${height})`)
                .call(d3.axisBottom(x0))
                .selectAll('text')
                .style('text-anchor', 'end')
                .attr('dx', '-.8em')
                .attr('dy', '.15em')
                .attr('transform', 'rotate(-45)');
            
            g.append('g')
                .attr('class', 'axis')
                .call(d3.axisLeft(yScale).tickFormat(d => d + '%'));
            
            // Labels
            g.append('text')
                .attr('class', 'axis-label')
                .attr('transform', 'rotate(-90)')
                .attr('y', 0 - margin.left)
                .attr('x', 0 - (height / 2))
                .attr('dy', '1em')
                .style('text-anchor', 'middle')
                .text('Prevalence (%)');
            
            g.append('text')
                .attr('class', 'axis-label')
                .attr('transform', `translate(${width/2}, ${height + margin.bottom - 10})`)
                .style('text-anchor', 'middle')
                .text('Age Groups');
            
            // Legend
            const legend = g.append('g')
                .attr('class', 'legend')
                .attr('transform', `translate(${width - 200}, 20)`);
            
            const legendItems = legend.selectAll('.legend-item')
                .data(disorders)
                .enter()
                .append('g')
                .attr('class', 'legend-item')
                .attr('transform', (d, i) => `translate(0, ${i * 20})`);
            
            legendItems.append('rect')
                .attr('width', 15)
                .attr('height', 15)
                .attr('fill', d => colorScale(d));
            
            legendItems.append('text')
                .attr('x', 20)
                .attr('y', 12)
                .style('font-size', '11px')
                .text(d => d.length > 15 ? d.substring(0, 15) + '...' : d);
        }
        
        // Event listeners
        document.getElementById('disorderSelect').addEventListener('change', createAgeChart);
        document.getElementById('chartType').addEventListener('change', createAgeChart);
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>
