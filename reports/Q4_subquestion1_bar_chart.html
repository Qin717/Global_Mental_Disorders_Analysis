<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Question 4 - Sub-question 1: Top Countries Bar Chart</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #4f81bd 0%, #70ad47 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0;
            font-size: 2.2em;
            font-weight: 300;
        }
        
        .header p {
            margin: 10px 0 0 0;
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .dashboard {
            padding: 30px;
        }
        
        .chart-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            margin-bottom: 30px;
        }
        
        .chart-title {
            font-size: 1.4em;
            font-weight: 600;
            margin-bottom: 20px;
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }
        
        .controls {
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .control-group label {
            font-weight: 600;
            color: #555;
            font-size: 0.9em;
        }
        
        select, input {
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        select:focus, input:focus {
            outline: none;
            border-color: #3498db;
        }
        
        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 1000;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .tooltip h4 {
            margin: 0 0 5px 0;
            color: #3498db;
        }
        
        .tooltip p {
            margin: 2px 0;
        }
        
        .bar {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .bar:hover {
            opacity: 0.8;
            stroke: #333;
            stroke-width: 2;
        }
        
        .axis {
            font-size: 12px;
        }
        
        .axis-label {
            font-size: 14px;
            font-weight: 600;
            fill: #555;
        }
        
        .grid-line {
            stroke: #e0e0e0;
            stroke-width: 1;
            opacity: 0.5;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 3px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }
        
        .value-label {
            font-size: 11px;
            text-anchor: middle;
            fill: #333;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Question 4 - Sub-question 1</h1>
            <p>Top Countries by Mental Disorder Prevalence (1990-2021)</p>
        </div>
        
        <div class="dashboard">
            <div class="stats-grid" id="statsGrid">
                <div class="stat-card">
                    <div class="stat-value" id="totalCountries">-</div>
                    <div class="stat-label">Countries Analyzed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalDisorders">-</div>
                    <div class="stat-label">Mental Disorders</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="avgPrevalence">-</div>
                    <div class="stat-label">Average Prevalence (%)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="highestPrevalence">-</div>
                    <div class="stat-label">Highest Prevalence (%)</div>
                </div>
            </div>
            
            <!-- Main Bar Chart -->
            <div class="chart-container">
                <h2 class="chart-title">Top Countries by Mental Disorder Prevalence</h2>
                <div class="controls">
                    <div class="control-group">
                        <label for="disorderSelect">Select Mental Disorder:</label>
                        <select id="disorderSelect">
                            <option value="all">All Disorders (Average)</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label for="countryCount">Number of Countries:</label>
                        <input type="number" id="countryCount" value="15" min="5" max="30">
                    </div>
                    <div class="control-group">
                        <label for="chartType">Chart Type:</label>
                        <select id="chartType">
                            <option value="horizontal">Horizontal Bar Chart</option>
                            <option value="vertical">Vertical Bar Chart</option>
                        </select>
                    </div>
                </div>
                <div id="barChart"></div>
            </div>
            
            <!-- Comparison Chart -->
            <div class="chart-container">
                <h2 class="chart-title">Top 5 Countries Comparison Across All Disorders</h2>
                <div id="comparisonChart"></div>
            </div>
        </div>
    </div>
    
    <div class="tooltip" id="tooltip"></div>
    
    <script>
        // Global variables
        let countryData = [];
        let allData = [];
        
        // Color schemes
        const colorSchemes = {
            disorders: d3.scaleOrdinal(d3.schemeCategory10),
            countries: d3.scaleOrdinal(d3.schemeSet3)
        };
        
        // Dimensions
        const dimensions = {
            barChart: { width: 1000, height: 500, margin: { top: 20, right: 50, bottom: 80, left: 120 } },
            comparisonChart: { width: 1000, height: 400, margin: { top: 20, right: 50, bottom: 80, left: 80 } }
        };
        
        // Tooltip
        const tooltip = d3.select("#tooltip");
        
        // Load data
        async function loadData() {
            try {
                console.log('Starting data load...');
                
                // Load country data
                console.log('Fetching Q4_country_data.csv...');
                const countryResponse = await fetch('Q4_country_data.csv');
                console.log('Response status:', countryResponse.status);
                console.log('Response ok:', countryResponse.ok);
                
                if (!countryResponse.ok) {
                    throw new Error(`Failed to load country data: ${countryResponse.status} ${countryResponse.statusText}`);
                }
                
                const countryText = await countryResponse.text();
                console.log('Country data text length:', countryText.length);
                console.log('First 200 chars:', countryText.substring(0, 200));
                
                countryData = d3.csvParse(countryText, d3.autoType);
                console.log('Country data parsed, records:', countryData.length);
                console.log('Sample data:', countryData.slice(0, 3));
                
                allData = countryData;
                console.log('Total records:', allData.length);
                
                // Update statistics
                updateStatistics();
                
                // Populate select options
                populateSelects();
                
                // Create visualizations
                console.log('Creating visualizations...');
                createBarChart();
                createComparisonChart();
                
                console.log('All visualizations created successfully!');
                
            } catch (error) {
                console.error('Error loading data:', error);
                console.error('Error stack:', error.stack);
                
                // Show detailed error information
                const errorDiv = document.createElement('div');
                errorDiv.style.cssText = 'color: red; background: #ffe6e6; padding: 20px; border-radius: 5px; margin: 20px;';
                errorDiv.innerHTML = `
                    <h3>Error Loading Data</h3>
                    <p><strong>Error:</strong> ${error.message}</p>
                    <p><strong>Error Type:</strong> ${error.name}</p>
                    <p><strong>Stack Trace:</strong></p>
                    <pre style="background: #f8f9fa; padding: 10px; border-radius: 3px; font-size: 12px; overflow-x: auto;">${error.stack}</pre>
                    <p><strong>Possible Solutions:</strong></p>
                    <ul>
                        <li>Make sure you're running a local web server (not opening the file directly)</li>
                        <li>Check that Q4_country_data.csv is in the same directory</li>
                        <li>Open browser developer tools (F12) and check the Console tab</li>
                        <li>Try the simple test: <a href="test_simple.html" target="_blank">test_simple.html</a></li>
                    </ul>
                    <p><strong>To start a local server:</strong></p>
                    <code>cd /Users/qinqin/Desktop/Mental_Disorders/reports && python3 -m http.server 8001</code><br/>
                    <code>Then open: http://localhost:8001/Q4_subquestion1_bar_chart.html</code>
                `;
                
                document.querySelector('.dashboard').appendChild(errorDiv);
            }
        }
        
        function updateStatistics() {
            const uniqueCountries = new Set(countryData.map(d => d.country)).size;
            const uniqueDisorders = new Set(allData.map(d => d.disorder)).size;
            const avgPrevalence = d3.mean(allData, d => d.avg_prevalence_percent);
            const maxPrevalence = d3.max(allData, d => d.avg_prevalence_percent);
            
            document.getElementById('totalCountries').textContent = uniqueCountries;
            document.getElementById('totalDisorders').textContent = uniqueDisorders;
            document.getElementById('avgPrevalence').textContent = avgPrevalence.toFixed(2);
            document.getElementById('highestPrevalence').textContent = maxPrevalence.toFixed(2);
        }
        
        function populateSelects() {
            const disorders = [...new Set(allData.map(d => d.disorder))].sort();
            
            const disorderSelect = d3.select('#disorderSelect');
            
            disorderSelect.selectAll('option')
                .data(['all', ...disorders])
                .enter()
                .append('option')
                .attr('value', d => d)
                .text(d => d === 'all' ? 'All Disorders (Average)' : d);
        }
        
        function createBarChart() {
            console.log('Creating bar chart...');
            const container = d3.select('#barChart');
            container.selectAll('*').remove();
            
            const svg = container.append('svg')
                .attr('width', dimensions.barChart.width)
                .attr('height', dimensions.barChart.height);
            
            const width = dimensions.barChart.width - dimensions.barChart.margin.left - dimensions.barChart.margin.right;
            const height = dimensions.barChart.height - dimensions.barChart.margin.top - dimensions.barChart.margin.bottom;
            
            const g = svg.append('g')
                .attr('transform', `translate(${dimensions.barChart.margin.left},${dimensions.barChart.margin.top})`);
            
            // Get filtered data
            const selectedDisorder = document.getElementById('disorderSelect').value;
            const countryCount = parseInt(document.getElementById('countryCount').value);
            const chartType = document.getElementById('chartType').value;
            
            let filteredData = countryData;
            if (selectedDisorder !== 'all') {
                filteredData = countryData.filter(d => d.disorder === selectedDisorder);
            }
            
            // Calculate average prevalence per country
            const countryAverages = [...new Set(filteredData.map(d => d.country))]
                .map(country => {
                    const countryData = filteredData.filter(d => d.country === country);
                    return {
                        country,
                        avgPrevalence: d3.mean(countryData, d => d.avg_prevalence_percent),
                        maxPrevalence: d3.max(countryData, d => d.avg_prevalence_percent),
                        minPrevalence: d3.min(countryData, d => d.avg_prevalence_percent),
                        disorderCount: countryData.length,
                        disorders: countryData.map(d => d.disorder)
                    };
                })
                .sort((a, b) => b.avgPrevalence - a.avgPrevalence)
                .slice(0, countryCount);
            
            console.log('Top countries for bar chart:', countryAverages.length);
            
            // Color scale
            const colorScale = d3.scaleOrdinal()
                .domain(countryAverages.map(d => d.country))
                .range(d3.schemeCategory10);
            
            if (chartType === 'horizontal') {
                // Horizontal bar chart
                const xScale = d3.scaleLinear()
                    .domain([0, d3.max(countryAverages, d => d.avgPrevalence)])
                    .range([0, width]);
                
                const yScale = d3.scaleBand()
                    .domain(countryAverages.map(d => d.country))
                    .range([0, height])
                    .padding(0.1);
                
                // Add grid lines
                g.selectAll('.grid-line')
                    .data(xScale.ticks(10))
                    .enter()
                    .append('line')
                    .attr('class', 'grid-line')
                    .attr('x1', d => xScale(d))
                    .attr('x2', d => xScale(d))
                    .attr('y1', 0)
                    .attr('y2', height);
                
                // Create bars
                g.selectAll('.bar')
                    .data(countryAverages)
                    .enter()
                    .append('rect')
                    .attr('class', 'bar')
                    .attr('x', 0)
                    .attr('y', d => yScale(d.country))
                    .attr('width', d => xScale(d.avgPrevalence))
                    .attr('height', yScale.bandwidth())
                    .attr('fill', d => colorScale(d.country))
                    .attr('opacity', 0.8)
                    .on('mouseover', function(event, d) {
                        tooltip.style('opacity', 1)
                            .html(`
                                <h4>${d.country}</h4>
                                <p><strong>Average Prevalence:</strong> ${d.avgPrevalence.toFixed(2)}%</p>
                                <p><strong>Range:</strong> ${d.minPrevalence.toFixed(2)}% - ${d.maxPrevalence.toFixed(2)}%</p>
                                <p><strong>Disorders:</strong> ${d.disorderCount}</p>
                                <p><strong>Disorder Types:</strong> ${d.disorders.join(', ')}</p>
                            `)
                            .style('left', (event.pageX + 10) + 'px')
                            .style('top', (event.pageY - 10) + 'px');
                    })
                    .on('mouseout', function() {
                        tooltip.style('opacity', 0);
                    });
                
                // Add value labels
                g.selectAll('.value-label')
                    .data(countryAverages)
                    .enter()
                    .append('text')
                    .attr('class', 'value-label')
                    .attr('x', d => xScale(d.avgPrevalence) + 5)
                    .attr('y', d => yScale(d.country) + yScale.bandwidth() / 2)
                    .attr('dy', '0.35em')
                    .text(d => d.avgPrevalence.toFixed(2) + '%');
                
                // Axes
                g.append('g')
                    .attr('class', 'axis')
                    .attr('transform', `translate(0,${height})`)
                    .call(d3.axisBottom(xScale).tickFormat(d => d + '%'));
                
                g.append('g')
                    .attr('class', 'axis')
                    .call(d3.axisLeft(yScale));
                
                // Labels
                g.append('text')
                    .attr('class', 'axis-label')
                    .attr('transform', 'rotate(-90)')
                    .attr('y', 0 - dimensions.barChart.margin.left)
                    .attr('x', 0 - (height / 2))
                    .attr('dy', '1em')
                    .style('text-anchor', 'middle')
                    .text('Countries');
                
                g.append('text')
                    .attr('class', 'axis-label')
                    .attr('transform', `translate(${width/2}, ${height + dimensions.barChart.margin.bottom - 10})`)
                    .style('text-anchor', 'middle')
                    .text('Average Prevalence (%)');
                
            } else {
                // Vertical bar chart
                const xScale = d3.scaleBand()
                    .domain(countryAverages.map(d => d.country))
                    .range([0, width])
                    .padding(0.1);
                
                const yScale = d3.scaleLinear()
                    .domain([0, d3.max(countryAverages, d => d.avgPrevalence)])
                    .range([height, 0]);
                
                // Add grid lines
                g.selectAll('.grid-line')
                    .data(yScale.ticks(10))
                    .enter()
                    .append('line')
                    .attr('class', 'grid-line')
                    .attr('x1', 0)
                    .attr('x2', width)
                    .attr('y1', d => yScale(d))
                    .attr('y2', d => yScale(d));
                
                // Create bars
                g.selectAll('.bar')
                    .data(countryAverages)
                    .enter()
                    .append('rect')
                    .attr('class', 'bar')
                    .attr('x', d => xScale(d.country))
                    .attr('y', d => yScale(d.avgPrevalence))
                    .attr('width', xScale.bandwidth())
                    .attr('height', d => height - yScale(d.avgPrevalence))
                    .attr('fill', d => colorScale(d.country))
                    .attr('opacity', 0.8)
                    .on('mouseover', function(event, d) {
                        tooltip.style('opacity', 1)
                            .html(`
                                <h4>${d.country}</h4>
                                <p><strong>Average Prevalence:</strong> ${d.avgPrevalence.toFixed(2)}%</p>
                                <p><strong>Range:</strong> ${d.minPrevalence.toFixed(2)}% - ${d.maxPrevalence.toFixed(2)}%</p>
                                <p><strong>Disorders:</strong> ${d.disorderCount}</p>
                                <p><strong>Disorder Types:</strong> ${d.disorders.join(', ')}</p>
                            `)
                            .style('left', (event.pageX + 10) + 'px')
                            .style('top', (event.pageY - 10) + 'px');
                    })
                    .on('mouseout', function() {
                        tooltip.style('opacity', 0);
                    });
                
                // Add value labels
                g.selectAll('.value-label')
                    .data(countryAverages)
                    .enter()
                    .append('text')
                    .attr('class', 'value-label')
                    .attr('x', d => xScale(d.country) + xScale.bandwidth() / 2)
                    .attr('y', d => yScale(d.avgPrevalence) - 5)
                    .attr('text-anchor', 'middle')
                    .text(d => d.avgPrevalence.toFixed(2) + '%');
                
                // Axes
                g.append('g')
                    .attr('class', 'axis')
                    .attr('transform', `translate(0,${height})`)
                    .call(d3.axisBottom(xScale))
                    .selectAll('text')
                    .style('text-anchor', 'end')
                    .attr('dx', '-.8em')
                    .attr('dy', '.15em')
                    .attr('transform', 'rotate(-45)');
                
                g.append('g')
                    .attr('class', 'axis')
                    .call(d3.axisLeft(yScale).tickFormat(d => d + '%'));
                
                // Labels
                g.append('text')
                    .attr('class', 'axis-label')
                    .attr('transform', 'rotate(-90)')
                    .attr('y', 0 - dimensions.barChart.margin.left)
                    .attr('x', 0 - (height / 2))
                    .attr('dy', '1em')
                    .style('text-anchor', 'middle')
                    .text('Average Prevalence (%)');
                
                g.append('text')
                    .attr('class', 'axis-label')
                    .attr('transform', `translate(${width/2}, ${height + dimensions.barChart.margin.bottom - 10})`)
                    .style('text-anchor', 'middle')
                    .text('Countries');
            }
        }
        
        function createComparisonChart() {
            console.log('Creating comparison chart...');
            const container = d3.select('#comparisonChart');
            container.selectAll('*').remove();
            
            const svg = container.append('svg')
                .attr('width', dimensions.comparisonChart.width)
                .attr('height', dimensions.comparisonChart.height);
            
            const width = dimensions.comparisonChart.width - dimensions.comparisonChart.margin.left - dimensions.comparisonChart.margin.right;
            const height = dimensions.comparisonChart.height - dimensions.comparisonChart.margin.top - dimensions.comparisonChart.margin.bottom;
            
            const g = svg.append('g')
                .attr('transform', `translate(${dimensions.comparisonChart.margin.left},${dimensions.comparisonChart.margin.top})`);
            
            // Get top 5 countries by overall average
            const top5Countries = [...new Set(countryData.map(d => d.country))]
                .map(country => {
                    const countryData = countryData.filter(d => d.country === country);
                    return {
                        country,
                        avgPrevalence: d3.mean(countryData, d => d.avg_prevalence_percent)
                    };
                })
                .sort((a, b) => b.avgPrevalence - a.avgPrevalence)
                .slice(0, 5);
            
            // Get data for these countries across all disorders
            const comparisonData = top5Countries.map(country => {
                const countryDisorders = countryData.filter(d => d.country === country.country);
                return {
                    country: country.country,
                    disorders: countryDisorders.map(d => ({
                        disorder: d.disorder,
                        prevalence: d.avg_prevalence_percent
                    }))
                };
            });
            
            // Flatten for grouped bar chart
            const flatData = [];
            comparisonData.forEach(country => {
                country.disorders.forEach(disorder => {
                    flatData.push({
                        country: country.country,
                        disorder: disorder.disorder,
                        prevalence: disorder.prevalence
                    });
                });
            });
            
            const disorders = [...new Set(flatData.map(d => d.disorder))];
            const countries = top5Countries.map(d => d.country);
            
            // Scales
            const x0 = d3.scaleBand()
                .domain(countries)
                .range([0, width])
                .padding(0.1);
            
            const x1 = d3.scaleBand()
                .domain(disorders)
                .range([0, x0.bandwidth()])
                .padding(0.05);
            
            const yScale = d3.scaleLinear()
                .domain([0, d3.max(flatData, d => d.prevalence)])
                .range([height, 0]);
            
            // Color scale
            const colorScale = d3.scaleOrdinal()
                .domain(disorders)
                .range(d3.schemeCategory10);
            
            // Create grouped bars
            g.selectAll('.country-group')
                .data(comparisonData)
                .enter()
                .append('g')
                .attr('class', 'country-group')
                .attr('transform', d => `translate(${x0(d.country)}, 0)`)
                .selectAll('.disorder-bar')
                .data(d => d.disorders)
                .enter()
                .append('rect')
                .attr('class', 'disorder-bar')
                .attr('x', d => x1(d.disorder))
                .attr('y', d => yScale(d.prevalence))
                .attr('width', x1.bandwidth())
                .attr('height', d => height - yScale(d.prevalence))
                .attr('fill', d => colorScale(d.disorder))
                .attr('opacity', 0.8)
                .on('mouseover', function(event, d) {
                    tooltip.style('opacity', 1)
                        .html(`
                            <h4>${d.country} - ${d.disorder}</h4>
                            <p><strong>Prevalence:</strong> ${d.prevalence.toFixed(2)}%</p>
                        `)
                        .style('left', (event.pageX + 10) + 'px')
                        .style('top', (event.pageY - 10) + 'px');
                })
                .on('mouseout', function() {
                    tooltip.style('opacity', 0);
                });
            
            // Axes
            g.append('g')
                .attr('class', 'axis')
                .attr('transform', `translate(0,${height})`)
                .call(d3.axisBottom(x0));
            
            g.append('g')
                .attr('class', 'axis')
                .call(d3.axisLeft(yScale).tickFormat(d => d + '%'));
            
            // Labels
            g.append('text')
                .attr('class', 'axis-label')
                .attr('transform', 'rotate(-90)')
                .attr('y', 0 - dimensions.comparisonChart.margin.left)
                .attr('x', 0 - (height / 2))
                .attr('dy', '1em')
                .style('text-anchor', 'middle')
                .text('Prevalence (%)');
            
            g.append('text')
                .attr('class', 'axis-label')
                .attr('transform', `translate(${width/2}, ${height + dimensions.comparisonChart.margin.bottom - 10})`)
                .style('text-anchor', 'middle')
                .text('Top 5 Countries');
            
            // Legend
            const legend = g.append('g')
                .attr('class', 'legend')
                .attr('transform', `translate(${width - 200}, 20)`);
            
            const legendItems = legend.selectAll('.legend-item')
                .data(disorders)
                .enter()
                .append('g')
                .attr('class', 'legend-item')
                .attr('transform', (d, i) => `translate(0, ${i * 20})`);
            
            legendItems.append('rect')
                .attr('width', 15)
                .attr('height', 15)
                .attr('fill', d => colorScale(d));
            
            legendItems.append('text')
                .attr('x', 20)
                .attr('y', 12)
                .style('font-size', '11px')
                .text(d => d.length > 15 ? d.substring(0, 15) + '...' : d);
        }
        
        // Event listeners
        document.getElementById('disorderSelect').addEventListener('change', createBarChart);
        document.getElementById('countryCount').addEventListener('change', createBarChart);
        document.getElementById('chartType').addEventListener('change', createBarChart);
        
        // Initialize
        loadData();
    </script>
</body>
</html>
